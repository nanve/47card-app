<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰èªè­˜01</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
<style>
Â  body { font-family: sans-serif; text-align: center; margin: 20px; }
Â  /* videoã¨resultã¯å¹…ã‚’èª¿æ•´ */
Â  video, #result { 
Â Â Â  width: 100%; 
Â Â Â  max-width: 400px; /* è¦‹ã‚„ã™ã„æœ€å¤§å¹… */
Â Â Â  height: auto; 
Â Â Â  margin: 10px auto; 
Â Â Â  border: 1px solid #ccc;
Â Â Â  display: block;
Â  }
Â  #canvas { display: none; }
Â  button { padding: 10px 15px; margin: 5px; cursor: pointer; }
Â  #result { border: 1px solid #007bff; padding: 15px; text-align: left; }
</style>
</head>
<body>
<h2>ğŸƒ ã‚«ãƒ¼ãƒ‰èªè­˜ãƒ†ã‚¹ãƒˆ</h2>

<video id="video" autoplay playsinline></video><br>
<button id="startCamera">ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
<button id="capture" disabled>æ’®å½±ã—ã¦èªè­˜</button>
<canvas id="canvas"></canvas>

<div id="result">èªè­˜çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const resultDiv = document.getElementById('result');
const captureButton = document.getElementById('capture');
const startCameraButton = document.getElementById('startCamera');

// ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿è¾æ›¸
const cardLinks = {
Â  "é™½å…‰èµ¤": "https://3bonya.com/47/2025/11/25/hello-world/" // èªè­˜æ–‡å­—+è‰²åã§ã‚­ãƒ¼ã‚’çµ±ä¸€
};

// 2. ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆã‚¢ã‚¦ãƒˆã‚«ãƒ¡ãƒ©å„ªå…ˆè¨­å®šã‚’é©ç”¨ï¼‰
startCameraButton.addEventListener('click', async () => {
Â  resultDiv.innerHTML = "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...";
Â  try {
Â  Â  // ã‚¢ã‚¦ãƒˆã‚«ãƒ¡ãƒ©ï¼ˆèƒŒé¢ã‚«ãƒ¡ãƒ©ï¼‰ã‚’å„ªå…ˆã™ã‚‹è¨­å®š
Â  Â  const constraints = {
Â  Â  Â  video: {
Â  Â  Â  Â  facingMode: "environment" 
Â  Â  Â  }
Â  Â  };
Â  Â  
Â  Â  const stream = await navigator.mediaDevices.getUserMedia(constraints);
Â  Â  // æ—¢ã«èµ·å‹•ä¸­ã®ã‚«ãƒ¡ãƒ©ãŒã‚ã‚Œã°ãƒˆãƒ©ãƒƒã‚¯ã‚’åœæ­¢ã—ã¦ã‹ã‚‰æ–°ã—ã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ã‚»ãƒƒãƒˆ
Â  Â  if (video.srcObject) {
Â  Â  Â  video.srcObject.getTracks().forEach(track => track.stop());
Â  Â  }
Â  Â  video.srcObject = stream;
Â  Â  captureButton.disabled = false; // èµ·å‹•ã—ãŸã‚‰æ’®å½±ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
Â  Â  resultDiv.innerHTML = "ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸã€‚ã‚«ãƒ¼ãƒ‰ã‚’æ’®å½±ã‚¨ãƒªã‚¢ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚";
Â  } catch (err) {
Â  Â  alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err.message + "ã€‚ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
Â  Â  resultDiv.innerHTML = `<p style="color:red;">ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
Â  }
});

// 3. æ’®å½±ï¼†èªè­˜ (Tesseract.jsã‚’awaitã§å®Ÿè¡Œ)
captureButton.addEventListener('click', async () => {
Â  if (!video.srcObject) {
Â Â Â  alert("å…ˆã«ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚");
Â Â Â  return;
Â  }
Â  
Â  resultDiv.innerHTML = "æ’®å½±ã—ã¦èªè­˜å‡¦ç†ä¸­...ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚";
Â  captureButton.disabled = true; // å‡¦ç†ä¸­ã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
Â  
Â  // æ’®å½±å‡¦ç†
Â  canvas.width = video.videoWidth;
Â  canvas.height = video.videoHeight;
Â  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

Â  try {
Â  Â  // 3-1. OCRå®Ÿè¡Œ
Â  Â  const { data: { text } } = await Tesseract.recognize(canvas, 'jpn');
Â  Â  // èªè­˜æ–‡å­—ã‹ã‚‰ç©ºç™½æ–‡å­—ã‚’ã™ã¹ã¦é™¤å»
Â  Â  const recognizedText = text.trim().replace(/\s/g, ''); 
Â  Â  console.log("èªè­˜æ–‡å­—:", recognizedText);

Â  Â  // 3-2. è‰²èªè­˜ï¼ˆå³ä¸Š50x50ãƒ”ã‚¯ã‚»ãƒ«ï¼‰
Â  Â  const imgData = ctx.getImageData(canvas.width - 50, 0, 50, 50);
Â  Â  let r = 0, g = 0, b = 0;
Â  Â  for (let i = 0; i < imgData.data.length; i += 4) {
Â  Â  Â  r += imgData.data[i];
Â  Â  Â  g += imgData.data[i + 1]; // ä¿®æ­£: g += ...
Â  Â  Â  b += imgData.data[i + 2]; // ä¿®æ­£: b += ...
Â  Â  }
Â  Â  const pixelCount = imgData.data.length / 4;
Â  Â  r = Math.round(r / pixelCount);
Â  Â  g = Math.round(g / pixelCount);
Â  Â  b = Math.round(b / pixelCount);

Â  Â  // 3-3. è‰²åˆ¤å®šï¼ˆç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
Â  Â  let colorName = "ä¸æ˜";
Â  Â  if (r > g && r > b && r > 150) colorName = "èµ¤"; // RãŒå„ªä½ã§æ˜ã‚‹ã„
Â  Â  else if (g > r && g > b && g > 150) colorName = "ç·‘"; // GãŒå„ªä½ã§æ˜ã‚‹ã„
Â  Â  else if (b > r && b > g && b > 150) colorName = "é’"; // BãŒå„ªä½ã§æ˜ã‚‹ã„
Â  Â  else if (r > 100 && g > 50 && b < 50) colorName = "èŒ¶"; // èŒ¶è‰²åˆ¤å®šï¼ˆèµ¤ã¨ç·‘ãŒå¼·ãé’ãŒå¼±ã„ï¼‰
Â  Â  else if (r > 200 && g > 200 && b > 200) colorName = "ç™½"; // ç™½ã£ã½ã„
Â  Â  else if (r < 50 && g < 50 && b < 50) colorName = "é»’"; // é»’ã£ã½ã„


Â  Â  console.log(`è‰²åˆ¤å®š: RGB(${r}, ${g}, ${b}) â†’ ${colorName}`);

Â  Â  // 3-4. çµæœã®è¡¨ç¤ºã¨è¾æ›¸æ¤œç´¢
Â  Â  const key = recognizedText + colorName; // èªè­˜æ–‡å­—ã¨è‰²åã‚’é€£çµã—ã¦ã‚­ãƒ¼ã‚’ä½œæˆ
Â  Â  
Â  Â  let outputHTML;
Â  Â  if (cardLinks[key]) {
Â  Â  Â  // ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ
Â  Â  Â  outputHTML = `<p>èªè­˜çµæœ: **${recognizedText}** (${colorName})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="${cardLinks[key]}" target="_blank">âœ… **${recognizedText}** ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’è¦‹ã‚‹</a>`;
Â  Â  } else {
Â  Â  Â  // ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ
Â  Â  Â  outputHTML = `<p>èªè­˜çµæœ: **${recognizedText}** (${colorName})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="color:orange;">è©²å½“ã‚«ãƒ¼ãƒ‰ **${key}** ãŒè¾æ›¸ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>`;
Â  Â  }
Â  Â  
Â  Â  resultDiv.innerHTML = outputHTML;

Â  } catch (ocrErr) {
Â  Â  resultDiv.innerHTML = `<p style="color:red;">èªè­˜å‡¦ç†ã‚¨ãƒ©ãƒ¼: Tesseract.jsã®å®Ÿè¡Œä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>`;
Â  Â  console.error(ocrErr);
Â  }
Â  
Â  captureButton.disabled = false; // å‡¦ç†å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
});
</script>
</body>
</html>