
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>オラクルカード認識</title>
<script/cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js</script>
<style>
  video, canvas { width: 300px; height: auto; }
  #result { margin-top: 20px; font-size: 18px; }
</style>
</head>
<body>
<h2>カード認識テスト</h2>
<video id="video" autoplay></video><br>
<button id="capture">撮影して認識</button>
<canvas id="canvas" style="display:none;"></canvas>
<div id="result"></div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const resultDiv = document.getElementById('result');
const ctx = canvas.getContext('2d');

// カメラ起動
navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => { video.srcObject = stream; })
  .catch(err => console.error("カメラ起動失敗:", err));

// カードデータ辞書
const cardLinks = {
  "陽光_赤": "https://3bonya.com/47/2025/11/25/hello-world/"
};

// 撮影＆認識
document.getElementById('capture').addEventListener('click', async () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // OCR実行
  const { data: { text } } = await Tesseract.recognize(canvas, 'jpn');
  const recognizedText = text.trim().replace(/\s/g, '');
  console.log("認識文字:", recognizedText);

  // 色認識（右上50x50ピクセル）
  const imgData = ctx.getImageData(canvas.width - 50, 0, 50, 50);
  let r = 0, g = 0, b = 0;
  for (let i = 0; i < imgData.data.length; i += 4) {
    r += imgData.data[i];
    g += imgData.data[i + 1];
    b += imgData.data[i + 2];
  }
  const pixelCount = imgData.data.length / 4;
  r = Math.round(r / pixelCount);
  g = Math.round(g / pixelCount);
  b = Math.round(b / pixelCount);

  // 色判定（簡易）
  let colorName = "不明";
  if (r > g && r > b) colorName = "赤";
  else if (r > 100 && g > 50 && b < 50) colorName = "茶";
  else if (g > r && g > b) colorName = "緑";

  console.log(`色判定: RGB(${r},${g},${b}) → ${colorName}`);

  // 辞書検索
  const key = `${recognizedText}_${colorName}`;
  if (cardLinks[key]) {
    resultDiv.innerHTML = `<p>認識結果: ${recognizedText} (${colorName})</p>
                            ${cardLinks[key]}カード情報を見る</a>`;
  } else {
    resultDiv.innerHTML = `<p>認識結果: ${recognizedText} (${colorName})</p>
                            <p>該当カードが見つかりません。</p>`;
  }
});
</script>
</body>
</html>
